var ArticleDetailController=["$scope","$routeParams","$window","$rootScope","uploadManager","Article","Channel",function(n,t,i,r,u,f,e){var o,s;return o=!1,n.channels=e.query({$expand:"Groups,Groups/Categorys"},function(){return t.id?(n.loading=!0,f.get({$filter:"PostId eq (guid'"+t.id+"')"},function(t){var h,i,r,u,f,c,l,a,e,o,s;for(n.entity=t.value[0],n.sourceTitle=n.entity.Title,n.channelId=n.entity.Group.Channel.ChannelId,n.groupId=n.entity.Group.GroupId,e=n.entity.Categorys,r=0,c=e.length;r<c;r++)for(h=e[r],o=n.getCategories(),u=0,l=o.length;u<l;u++)i=o[u],i.CategoryId===h.CategoryId&&(i.checked=!0);if(n.entity.Tags){for(n.tags="",s=n.entity.Tags,f=0,a=s.length;f<a;f++)i=s[f],n.tags+=","+i.Name;n.tags=n.tags.substring(1)}return n.loading=!1})):(n.entity={},n.entity.PostId=UUID.generate(),o=!0)}),n.getGroups=function(){var i,t,u,r;if(n.channels.value===void 0)return void 0;for(r=n.channels.value,t=0,u=r.length;t<u;t++)if(i=r[t],i.ChannelId===n.channelId)return i.Groups},n.getCategories=function(){var i,t,u,r;if(n.getGroups()===void 0)return void 0;for(r=n.getGroups(),t=0,u=r.length;t<u;t++)if(i=r[t],i.GroupId===n.groupId)return i.Categorys},n.categorySelect=function(n){return n.checked=n.checked?!0:!1},n.submit=function(){return(n.isSubmit=!0,!n.channelValid())?!1:n.groupValid()?n.categoryValid()?n.entity.Url?n.entity.Title?n.entity.Content?n.entity.Description?(n.loading=!0,n.files.length?u.upload():s()):!1:!1:!1:!1:!1:!1},n.channelValid=function(){return n.getGroups()?!0:!1},n.groupValid=function(){return n.getCategories()?!0:!1},n.categoryValid=function(){var r,t,u,i;if(!n.getCategories())return!1;for(i=n.getCategories(),t=0,u=i.length;t<u;t++)if(r=i[t],r.checked)return!0;return!1},s=function(){var t,r,u,e,c,l,s,h;for(t=n.entity,t.Group={},t.Group.GroupId=function(){var t,f,i,u;for(i=n.getGroups(),u=[],t=0,f=i.length;t<f;t++)r=i[t],r.GroupId===n.groupId&&u.push(r);return u}()[0].GroupId,t.Categorys=[],s=n.getCategories(),u=0,c=s.length;u<c;u++)r=s[u],r.checked&&t.Categorys.push({CategoryId:r.CategoryId});if(t.Tags=[],n.tags)for(h=n.tags.split(","),e=0,l=h.length;e<l;e++)r=h[e],t.Tags.push({TagId:UUID.generate(),Name:r});return t.Source&&(t.Source.SourceId=UUID.generate()),o?(t.PostId=UUID.generate(),f.save(t,function(n){return i.location.href="/#!/post/"+n.Url})):f.update({id:"(guid'"+t.PostId+"')"},t,function(n){return i.location.href="/#!/post/"+n.Url})},n.files=[],n.removeImg=function(t){var e,r,i,o,f;for(f=n.files,i=0,o=f.length;i<o;i++)r=f[i],r.name===t.name&&(e=r);return n.files.splice(n.files.indexOf(e),1),u.cancel(t)},n.removeServerImg=function(){return n.entity.Thumbnail=null},r.$on("fileAdded",function(t,i){return n.files.push(i),n.$apply()}),r.$on("fileUploaded",function(t,i){return n.entity.Thumbnail={ThumbnailId:UUID.generate(),Title:n.entity.Title,Url:i.result},s()}),n.getUrl=function(){var t;return n.TranslateUrl=!0,i.mycallback=function(t){return t=$.trim(t),t=t.toLowerCase(),t=t.replace(/[^_a-zA-Z\d\s]/g,""),t=t.replace(/[\s]/g,"-"),n.entity.Url=t,n.TranslateUrl=!1,n.$apply()},t=document.createElement("script"),t.src="http://api.microsofttranslator.com/V2/Ajax.svc/Translate?oncomplete=mycallback&appId=A4D660A48A6A97CCA791C34935E4C02BBB1BEC1C&from=zh-cn&to=en&text="+n.entity.Title,document.getElementsByTagName("head")[0].appendChild(t)}}]